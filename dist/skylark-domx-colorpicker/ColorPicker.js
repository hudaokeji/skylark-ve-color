/**
 * skylark-domx-colorpicker - The skylark dom plugin for picking color 
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-domx/skylark-domx-colorpicker/
 * @license MIT
 */
define(["skylark-langx/skylark","skylark-langx/langx","skylark-domx-browser","skylark-domx-noder","skylark-domx-finder","skylark-domx-query","skylark-domx-eventer","skylark-domx-styler","skylark-domx-fx","skylark-domx-plugins","skylark-domx-popups","skylark-graphics-color","./draggable"],function(e,t,s,a,o,l,r,i,n,c,p,d,f){"use strict";var h=t.noop,u=[],g=["<div class='sp-replacer'>","<div class='sp-preview'><div class='sp-preview-inner'></div></div>","<div class='sp-dd'>&#9660;</div>","</div>"].join(""),v=function(){var e="";if(s.isIE)for(var t=1;t<=6;t++)e+="<div class='sp-"+t+"'></div>";return["<div class='sp-container sp-hidden'>","<div class='sp-palette-container'>","<div class='sp-palette sp-thumb sp-cf'></div>","<div class='sp-palette-button-container sp-cf'>","<button type='button' class='sp-palette-toggle'></button>","</div>","</div>","<div class='sp-picker-container'>","<div class='sp-top sp-cf'>","<div class='sp-fill'></div>","<div class='sp-top-inner'>","<div class='sp-color'>","<div class='sp-sat'>","<div class='sp-val'>","<div class='sp-dragger'></div>","</div>","</div>","</div>","<div class='sp-clear sp-clear-display'>","</div>","<div class='sp-hue'>","<div class='sp-slider'></div>",e,"</div>","</div>","<div class='sp-alpha'><div class='sp-alpha-inner'><div class='sp-alpha-handle'></div></div></div>","</div>","<div class='sp-input-container sp-cf'>","<input class='sp-input' type='text' spellcheck='false'  />","</div>","<div class='sp-initial sp-thumb sp-cf'></div>","<div class='sp-button-container sp-cf'>","<a class='sp-cancel' href='#'></a>","<button type='button' class='sp-choose'></button>","</div>","</div>","</div>"].join("")}();function k(e,t,s,a){for(var o=[],r=0;r<e.length;r++){var i=e[r];if(i){var n=d.parse(i),c=n.toHsl().l<.5?"sp-thumb-el sp-thumb-dark":"sp-thumb-el sp-thumb-light";c+=d.equals(t,i)?" sp-thumb-active":"";var p=n.toString(a.preferredFormat||"rgb"),f="background-color:"+n.toRgbString();o.push('<span title="'+p+'" data-color="'+n.toRgbString()+'" class="'+c+'"><span class="sp-thumb-inner" style="'+f+';" /></span>')}else{o.push(l("<div />").append(l('<span data-color="" style="background-color:transparent;" class="sp-clear-display"></span>').attr("title",a.noColorSelectedText)).html())}}return"<div class='sp-cf "+s+"'>"+o.join("")+"</div>"}var m=c.Plugin.inherit({klassName:"ColorPicker",pluginName:"domx.colorPicker",options:{beforeShow:h,move:h,change:h,show:h,hide:h,color:!1,flat:!1,showInput:!1,allowEmpty:!1,showButtons:!0,clickoutFiresChange:!0,showInitial:!1,showPalette:!1,showPaletteOnly:!1,hideAfterPaletteSelect:!1,togglePaletteOnly:!1,showSelectionPalette:!0,localStorageKey:!1,appendTo:"body",maxSelectionSize:7,cancelText:"cancel",chooseText:"choose",togglePaletteMoreText:"more",togglePaletteLessText:"less",clearText:"Clear Color Selection",noColorSelectedText:"No Color Selected",preferredFormat:!1,className:"",containerClassName:"",replacerClassName:"",showAlpha:!1,theme:"sp-light",palette:[["#ffffff","#000000","#ff0000","#ff8000","#ffff00","#008000","#0000ff","#4b0082","#9400d3"]],selectionPalette:[],disabled:!1,offset:null},_construct:function(e,a){this.overrided(e,a);var o=this.options,i=this._elm,n=o.flat,c=o.showSelectionPalette,h=o.theme,m=t.debounce(qe,10),C=!1,P=!1,y=0,x=0,S=0,T=0,F=0,I=0,M=0,O=0,A=0,N=0,R=1,z=[],D=[],E={},j=o.selectionPalette.slice(0),q=o.maxSelectionSize,H="sp-dragging",B=null,K=o.callbacks={move:w(o.move,e),change:w(o.change,e),show:w(o.show,e),hide:w(o.hide,e),beforeShow:w(o.beforeShow,e)},L=i.ownerDocument,V=(L.body,l(i)),_=!1,W=l(v,L).addClass(h),G=W.find(".sp-picker-container"),J=W.find(".sp-color"),Q=W.find(".sp-dragger"),U=W.find(".sp-hue"),X=W.find(".sp-slider"),Y=W.find(".sp-alpha-inner"),Z=W.find(".sp-alpha"),$=W.find(".sp-alpha-handle"),ee=W.find(".sp-input"),te=W.find(".sp-palette"),se=W.find(".sp-initial"),ae=W.find(".sp-cancel"),oe=W.find(".sp-clear"),le=W.find(".sp-choose"),re=W.find(".sp-palette-toggle"),ie=V.is("input"),ne=ie&&"color"===V.attr("type")&&inputTypeColorSupport(),ce=ie&&!n,pe=ce?l(g).addClass(h).addClass(o.className).addClass(o.replacerClassName):l([]),de=ce?pe:V,fe=pe.find(".sp-preview-inner"),he=o.color||ie&&V.val(),ue=!1,ge=o.preferredFormat,ve=!o.showButtons||o.clickoutFiresChange,ke=!he,me=o.allowEmpty&&!ne;function be(){if(o.showPaletteOnly&&(o.showPalette=!0),re.text(o.showPaletteOnly?o.togglePaletteMoreText:o.togglePaletteLessText),o.palette){z=o.palette.slice(0),D=t.isArray(z[0])?z:[z],E={};for(var e=0;e<D.length;e++)for(var s=0;s<D[e].length;s++){var a=d.parse(D[e][s]).toRgbString();E[a]=!0}}W.toggleClass("sp-flat",n),W.toggleClass("sp-input-disabled",!o.showInput),W.toggleClass("sp-alpha-enabled",o.showAlpha),W.toggleClass("sp-clear-enabled",me),W.toggleClass("sp-buttons-disabled",!o.showButtons),W.toggleClass("sp-palette-buttons-disabled",!o.togglePaletteOnly),W.toggleClass("sp-palette-disabled",!o.showPalette),W.toggleClass("sp-palette-only",o.showPaletteOnly),W.toggleClass("sp-initial-disabled",!o.showInitial),W.addClass(o.className).addClass(o.containerClassName),qe()}function we(e){if(c){var s=d.parse(e).toRgbString();if(!E[s]&&-1===t.inArray(s,j))for(j.push(s);j.length>q;)j.shift()}}function Ce(){var e=Re(),s=t.map(D,function(t,s){return k(t,e,"sp-palette-row sp-palette-row-"+s,o)});j&&s.push(k(function(){var e=[];if(o.showPalette)for(var t=0;t<j.length;t++){var s=d.parse(j[t]).toRgbString();E[s]||e.push(j[t])}return e.reverse().slice(0,o.maxSelectionSize)}(),e,"sp-palette-row sp-palette-row-selection",o)),te.html(s.join(""))}function Pe(){if(o.showInitial){var e=ue,t=Re();se.html(k([e,t],t,"sp-palette-row-initial",o))}}function ye(){(x<=0||y<=0||T<=0)&&qe(),P=!0,W.addClass(H),B=null,V.trigger("dragstart.ColorPicker",[Re()])}function xe(){P=!1,W.removeClass(H),V.trigger("dragstop.ColorPicker",[Re()])}function Se(){var e=ee.val();if(null!==e&&""!==e||!me){var t=d.parse(e);t.isValid()?(Ne(t),ze(),je()):ee.addClass("sp-validation-error")}else Ne(null),ze(),je()}function Te(e){27===e.keyCode&&Oe()}function Fe(e){2!=e.button&&(P||(ve?je(!0):Ae(),Oe()))}function Ie(){C?Oe():Me()}function Me(){var e=r.create("beforeShow.ColorPicker");C?qe():(V.trigger(e,[Re()]),!1===K.beforeShow(Re())||e.isDefaultPrevented()||(!function(){for(var e=0;e<u.length;e++)u[e]&&u[e].hide()}(),C=!0,l(L).on("keydown.ColorPicker",Te),l(L).on("click.ColorPicker",Fe),l(window).on("resize.ColorPicker",m),pe.addClass("sp-active"),W.removeClass("sp-hidden"),qe(),De(),ue=Re(),Pe(),K.show(ue),V.trigger("show.ColorPicker",[ue])))}function Oe(){C&&!n&&(C=!1,l(L).off("keydown.ColorPicker",Te),l(L).off("click.ColorPicker",Fe),l(window).off("resize.ColorPicker",m),pe.removeClass("sp-active"),W.addClass("sp-hidden"),K.hide(Re()),V.trigger("hide.ColorPicker",[Re()]))}function Ae(){Ne(ue,!0),je(!0)}function Ne(e,t){var s,a;d.equals(e,Re())?De():(!e&&me?ke=!0:(ke=!1,a=(s=d.parse(e)).toHsv(),O=a.h%360/360,A=a.s,N=a.v,R=a.a),De(),s&&s.isValid()&&!t&&(ge=o.preferredFormat||s.getFormat()))}function Re(e){return e=e||{},me&&ke?null:d.parse({h:360*O,s:A,v:N,a:Math.round(1e3*R)/1e3})}function ze(){De(),K.move(Re()),V.trigger("move.ColorPicker",[Re()])}function De(){ee.removeClass("sp-validation-error"),Ee();var e=d.parse({h:360*O,s:1,v:1});J.css("background-color",e.toHexString());var t=ge;R<1&&(0!==R||"name"!==t)&&("hex"!==t&&"hex3"!==t&&"hex6"!==t&&"name"!==t||(t="rgb"));var a=Re({format:t}),l="";if(fe.removeClass("sp-clear-display"),fe.css("background-color","transparent"),!a&&me)fe.addClass("sp-clear-display");else{var r=a.toHexString(),i=a.toRgbString();if(fe.css("background-color",i),o.showAlpha){var n=a.toRgb();n.a=0;var c=d.parse(n).toRgbString(),p="linear-gradient(left, "+c+", "+r+")";s.isIE?Y.css("filter",d.parse(c).toFilter({gradientType:1},r)):(Y.css("background","-webkit-"+p),Y.css("background","-moz-"+p),Y.css("background","-ms-"+p),Y.css("background","linear-gradient(to right, "+c+", "+r+")"))}l=a.toString(t)}o.showInput&&ee.val(l),o.showPalette&&Ce(),Pe()}function Ee(){var e=A,t=N;if(me&&ke)$.hide(),X.hide(),Q.hide();else{$.show(),X.show(),Q.show();var s=e*y,a=x-t*x;s=Math.max(-S,Math.min(y-S,s-S)),a=Math.max(-S,Math.min(x-S,a-S)),Q.css({top:a+"px",left:s+"px"});var o=R*F;$.css({left:o-I/2+"px"});var l=O*T;X.css({top:l-M+"px"})}}function je(e){var t=Re(),s="",a=!d.equals(t,ue);t&&(s=t.toString(ge),we(t)),ie&&V.val(s),e&&a&&(K.change(t),V.trigger("change",[t]))}function qe(){C&&(y=J.width(),x=J.height(),S=Q.height(),U.width(),T=U.height(),M=X.height(),F=Z.width(),I=$.width(),n||(W.css("position","absolute"),o.offset?W.offset(o.offset):W.offset(p.calcOffset(W[0],de[0]))),Ee(),o.showPalette&&Ce(),V.trigger("reflow.ColorPicker"))}function He(){Oe(),_=!0,V.attr("disabled",!0),de.addClass("sp-disabled")}!function(){if(s.isIE&&W.find("*:not(input)").attr("unselectable","on"),be(),ce&&V.after(pe).hide(),me||oe.hide(),n)V.after(W).hide();else{var e="parent"===o.appendTo?V.parent():l(o.appendTo);1!==e.length&&(e=l("body")),e.append(W)}function t(e){return e.data&&e.data.ignore?(Ne(l(e.target).closest(".sp-thumb-el").data("color")),ze()):(Ne(l(e.target).closest(".sp-thumb-el").data("color")),ze(),o.hideAfterPaletteSelect?(je(!0),Oe()):je()),!1}de.on("click.ColorPicker touchstart.ColorPicker",function(e){_||Ie(),e.stopPropagation(),l(e.target).is("input")||e.preventDefault()}),(V.is(":disabled")||!0===o.disabled)&&He(),W.click(b),ee.change(Se),ee.on("paste",function(){setTimeout(Se,1)}),ee.keydown(function(e){13==e.keyCode&&Se()}),ae.text(o.cancelText),ae.on("click.ColorPicker",function(e){e.stopPropagation(),e.preventDefault(),Ae(),Oe()}),oe.attr("title",o.clearText),oe.on("click.ColorPicker",function(e){e.stopPropagation(),e.preventDefault(),ke=!0,ze(),n&&je(!0)}),le.text(o.chooseText),le.on("click.ColorPicker",function(e){e.stopPropagation(),e.preventDefault(),s.isIE&&ee.is(":focus")&&ee.trigger("change"),ee.hasClass("sp-validation-error")||(je(!0),Oe())}),re.text(o.showPaletteOnly?o.togglePaletteMoreText:o.togglePaletteLessText),re.on("click.spectrum",function(e){e.stopPropagation(),e.preventDefault(),o.showPaletteOnly=!o.showPaletteOnly,o.showPaletteOnly||n||W.css("left","-="+(G.outerWidth(!0)+5)),be()}),f(Z,function(e,t,s){R=e/F,ke=!1,s.shiftKey&&(R=Math.round(10*R)/10),ze()},ye,xe),f(U,function(e,t){O=parseFloat(t/T),ke=!1,o.showAlpha||(R=1),ze()},ye,xe),f(J,function(e,t,s){if(s.shiftKey){if(!B){var a=A*y,l=x-N*x,r=Math.abs(e-a)>Math.abs(t-l);B=r?"x":"y"}}else B=null;var i=!B||"y"===B;(!B||"x"===B)&&(A=parseFloat(e/y)),i&&(N=parseFloat((x-t)/x)),ke=!1,o.showAlpha||(R=1),ze()},ye,xe),he?(Ne(he),De(),ge=o.preferredFormat||d.parse(he).format,we(he)):De(),n&&Me();var a=s.isIE?"mousedown.ColorPicker":"click.ColorPicker touchstart.ColorPicker";te.on(a,".sp-thumb-el",t),se.on(a,".sp-thumb-el:nth-child(1)",{ignore:!0},t)}(),t.mixin(this,{show:Me,hide:Oe,toggle:Ie,reflow:qe,option:function(e,s){return void 0===e?t.mixin({},o):void 0===s?o[e]:(o[e]=s,"preferredFormat"===e&&(ge=o.preferredFormat),void be())},enable:function(){_=!1,V.attr("disabled",!1),de.removeClass("sp-disabled")},disable:He,offset:function(e){o.offset=e,qe()},set:function(e){Ne(e),je()},get:Re,destroy:function(){V.show(),de.off("click.ColorPicker touchstart.ColorPicker"),W.remove(),pe.remove(),u[spect.id]=null},container:W})}});function b(e){e.stopPropagation()}function w(e,t){var s=Array.prototype.slice,a=s.call(arguments,2);return function(){return e.apply(t,a.concat(s.call(arguments)))}}return c.register(m,"colorPicker"),m.draggable=f,m.localization={},m.palettes={},e.attach("domx.ColorPicker",m)});
//# sourceMappingURL=sourcemaps/ColorPicker.js.map
